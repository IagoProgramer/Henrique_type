const texts = {
  pt: {
    universal: {
      easy: {
        normal: [
          "cadeira mesa livro papel caneta telefone relogio porta janela cama almofada tapete quadro",
          "garfo prato copo agua suco cafe cha leite acucar sal pimenta pao manteiga queijo presunto",
          "sapato meia calca camisa blusa casaco chapeu luva cinto bolsa carteira relogio oculos",
          "cachorro gato peixe passaro coelho hamster papagaio tartaruga porquinho rato girafa leao",
          "cozinha sala quarto banheiro garagem jardim quintal varanda sacada escritorio lavanderia",
          "medico advogado professor engenheiro dentista arquiteto vendedor contador cozinheiro ator",
          "violao guitarra piano bateria flauta saxofone violino harpa tambor teclado microfone",
          "montanha praia deserto floresta rio lago oceano ilha caverna cachoeira vulcao geleira",
          "aviao helicoptero trem onibus carro moto bicicleta barco navio foguete submarino",
          "pintura escultura danca teatro cinema musica literatura poesia fotografia artesanato",
          "hospital escola banco correio farmacia padaria mercado shopping cinema teatro museu",
          "banana maca laranja uva pera manga abacaxi morango melancia kiwi mamao pessego ameixa",
          "tomate alface cenoura batata cebola alho pepino brocolis couve espinafre abobrinha",
          "arroz feijao macarrao carne frango peixe salada sopa molho tempero azeite vinagre",
          "chocolate sorvete bolo pudim doce torta biscoito pipoca amendoim castanha brigadeiro",
          "computador teclado mouse monitor impressora scanner notebook tablet celular carregador",
          "pasta arquivo documento planilha relatorio contrato proposta projeto agenda calendario",
          "televisao radio microondas geladeira fogao maquina lavlouca aspirador ventilador",
          "futebol volei basquete tenis natacao corrida ciclismo boxe surf xadrez yoga pilates",
          "energia agua luz gas internet telefone conta imposto aluguel salario investimento"
        ],
        accents: [
          "cadeira mesa livro papel caneta telefone relógio porta janela cama almofada tapete quadro",
          "garfo prato copo água suco café chá leite açúcar sal pimenta pão manteiga queijo presunto",
          "sapato meia calça camisa blusa casaco chapéu luva cinto bolsa carteira relógio óculos",
          "cachorro gato peixe pássaro coelho hamster papagaio tartaruga porquinho rato girafa leão",
          "cozinha sala quarto banheiro garagem jardim quintal varanda sacada escritório lavanderia",
          "médico advogado professor engenheiro dentista arquiteto vendedor contador cozinheiro ator",
          "violão guitarra piano bateria flauta saxofone violino harpa tambor teclado microfone",
          "montanha praia deserto floresta rio lago oceano ilha caverna cachoeira vulcão geleira",
          "avião helicóptero trem ônibus carro moto bicicleta barco navio foguete submarino",
          "pintura escultura dança teatro cinema música literatura poesia fotografia artesanato",
          "hospital escola banco correio farmácia padaria mercado shopping cinema teatro museu",
          "banana maçã laranja uva pera manga abacaxi morango melancia kiwi mamão pêssego ameixa",
          "tomate alface cenoura batata cebola alho pepino brócolis couve espinafre abobrinha",
          "arroz feijão macarrão carne frango peixe salada sopa molho tempero azeite vinagre",
          "chocolate sorvete bolo pudim doce torta biscoito pipoca amendoim castanha brigadeiro",
          "computador teclado mouse monitor impressora scanner notebook tablet celular carregador",
          "pasta arquivo documento planilha relatório contrato proposta projeto agenda calendário",
          "televisão rádio micro-ondas geladeira fogão máquina lava-louça aspirador ventilador",
          "futebol vôlei basquete tênis natação corrida ciclismo boxe surf xadrez yoga pilates",
          "energia água luz gás internet telefone conta imposto aluguel salário investimento"
        ],
        punctuation: [
          "cadeira, mesa, livro, papel, caneta, telefone, relógio, porta, janela, cama, almofada, tapete, quadro.",
          "garfo, prato, copo, água, suco, café, chá, leite, açúcar, sal, pimenta, pão, manteiga, queijo, presunto.",
          "sapato, meia, calça, camisa, blusa, casaco, chapéu, luva, cinto, bolsa, carteira, relógio, óculos.",
          "cachorro, gato, peixe, pássaro, coelho, hamster, papagaio, tartaruga, porquinho, rato, girafa, leão.",
          "cozinha, sala, quarto, banheiro, garagem, jardim, quintal, varanda, sacada, escritório, lavanderia.",
          "médico, advogado, professor, engenheiro, dentista, arquiteto, vendedor, contador, cozinheiro, ator.",
          "violão, guitarra, piano, bateria, flauta, saxofone, violino, harpa, tambor, teclado, microfone.",
          "montanha, praia, deserto, floresta, rio, lago, oceano, ilha, caverna, cachoeira, vulcão, geleira.",
          "avião, helicóptero, trem, ônibus, carro, moto, bicicleta, barco, navio, foguete, submarino.",
          "pintura, escultura, dança, teatro, cinema, música, literatura, poesia, fotografia, artesanato.",
          "hospital, escola, banco, correio, farmácia, padaria, mercado, shopping, cinema, teatro, museu.",
          "banana, maçã, laranja, uva, pera, manga, abacaxi, morango, melancia, kiwi, mamão, pêssego, ameixa.",
          "tomate, alface, cenoura, batata, cebola, alho, pepino, brócolis, couve, espinafre, abobrinha.",
          "arroz, feijão, macarrão, carne, frango, peixe, salada, sopa, molho, tempero, azeite, vinagre.",
          "chocolate, sorvete, bolo, pudim, doce, torta, biscoito, pipoca, amendoim, castanha, brigadeiro.",
          "computador, teclado, mouse, monitor, impressora, scanner, notebook, tablet, celular, carregador.",
          "pasta, arquivo, documento, planilha, relatório, contrato, proposta, projeto, agenda, calendário.",
          "televisão, rádio, micro-ondas, geladeira, fogão, máquina lava-louça, aspirador, ventilador.",
          "futebol, vôlei, basquete, tênis, natação, corrida, ciclismo, boxe, surf, xadrez, yoga, pilates.",
          "energia, água, luz, gás, internet, telefone, conta, imposto, aluguel, salário, investimento"
        ]
      }
    },
    javascript: {
      easy: {
        normal: [
          "array objeto string numero funcao metodo classe evento loop codigo retorno escopo dados",
          "botao formulario campo texto lista menu tabela modal janela interface layout estrutura",
          "variavel constante escopo local global funcao regex expressao modulo componente estado",
          "promise async await fetch api rest crud token cookie sessao storage cache proxy middleware",
          "frontend backend fullstack deploy servidor cliente banco dados hospedagem dominio dns ssl",
          "framework biblioteca componente estado prop hook contexto redux mobx styled router saga",
          "typescript javascript node express react angular vue svelte jquery bootstrap tailwind",
          "webpack babel eslint prettier jest karma mocha chai cypress selenium docker kubernetes",
          "algoritmo estrutura dados arvore grafo pilha fila hash tabela ordenacao busca recursao",
          "debug erro excecao log teste unitario mock stub spy cobertura qualidade performance"
        ],
        accents: [
          "array objeto string número função método classe evento loop código retorno escopo dados",
          "botão formulário campo texto lista menu tabela modal janela interface layout estrutura",
          "variável constante escopo local global função regex expressão módulo componente estado",
          "promise async await fetch api rest crud token cookie sessão storage cache proxy middleware",
          "frontend backend fullstack deploy servidor cliente banco dados hospedagem domínio dns ssl",
          "framework biblioteca componente estado prop hook contexto redux mobx styled router saga",
          "typescript javascript node express react angular vue svelte jquery bootstrap tailwind",
          "webpack babel eslint prettier jest karma mocha chai cypress selenium docker kubernetes",
          "algoritmo estrutura dados árvore grafo pilha fila hash tabela ordenação busca recursão",
          "debug erro exceção log teste unitário mock stub spy cobertura qualidade performance"
        ],
        punctuation: [
          "array, objeto, string, número, função, método, classe, evento, loop, código, retorno, escopo, dados.",
          "botão, formulário, campo, texto, lista, menu, tabela, modal, janela, interface, layout, estrutura.",
          "variável, constante, escopo, local, global, função, regex, expressão, módulo, componente, estado.",
          "promise, async, await, fetch, api, rest, crud, token, cookie, sessão, storage, cache, proxy, middleware.",
          "frontend, backend, fullstack, deploy, servidor, cliente, banco, dados, hospedagem, domínio, dns, ssl.",
          "framework, biblioteca, componente, estado, prop, hook, contexto, redux, mobx, styled, router, saga.",
          "typescript, javascript, node, express, react, angular, vue, svelte, jquery, bootstrap, tailwind.",
          "webpack, babel, eslint, prettier, jest, karma, mocha, chai, cypress, selenium, docker, kubernetes.",
          "algoritmo, estrutura, dados, árvore, grafo, pilha, fila, hash, tabela, ordenação, busca, recursão.",
          "debug, erro, exceção, log, teste, unitário, mock, stub, spy, cobertura, qualidade, performance."
        ]
      }
    }
  },
  en: {
    universal: {
      easy: {
        normal: [
          "chair table book paper pencil phone clock door window bed pillow carpet picture frame",
          "fork plate glass water juice coffee tea milk sugar salt pepper bread butter cheese ham",
          "shoes socks pants shirt blouse jacket hat glove belt bag wallet watch glasses clothes",
          "doctor lawyer teacher engineer dentist architect salesman accountant chef actor writer",
          "guitar piano drums flute saxophone violin harp trumpet keyboard microphone speaker bass",
          "mountain beach desert forest river lake ocean island cave waterfall volcano glacier",
          "plane helicopter train bus car motorcycle bicycle boat ship rocket submarine scooter",
          "painting sculpture dance theater cinema music literature poetry photography crafts art",
          "hospital school bank post office pharmacy bakery market mall cinema theater museum gym",
          "banana apple orange grape pear mango pineapple strawberry watermelon kiwi papaya peach",
          "tomato lettuce carrot potato onion garlic cucumber broccoli cabbage spinach zucchini",
          "rice beans pasta meat chicken fish salad soup sauce seasoning olive oil vinegar herbs",
          "chocolate ice cream cake pudding candy pie cookie popcorn peanut cashew brownie sweet",
          "computer keyboard mouse monitor printer scanner laptop tablet phone charger headphones",
          "folder file document spreadsheet report contract proposal project agenda calendar notes",
          "television radio microwave fridge stove dishwasher vacuum fan heater air conditioner",
          "soccer volleyball basketball tennis swimming running cycling boxing surf chess yoga",
          "energy water light gas internet phone bill tax rent salary investment savings stock",
          "morning afternoon evening night dawn dusk sunrise sunset today tomorrow yesterday time",
          "spring summer autumn winter rain snow wind storm cloud rainbow thunder lightning weather"
        ],
        accents: [
          "chair table book paper pencil phone clock door window bed pillow carpet picture frame",
          "fork plate glass water juice coffee tea milk sugar salt pepper bread butter cheese ham",
          "shoes socks pants shirt blouse jacket hat glove belt bag wallet watch glasses clothes",
          "doctor lawyer teacher engineer dentist architect salesman accountant chef actor writer",
          "guitar piano drums flute saxophone violin harp trumpet keyboard microphone speaker bass",
          "mountain beach desert forest river lake ocean island cave waterfall volcano glacier",
          "plane helicopter train bus car motorcycle bicycle boat ship rocket submarine scooter",
          "painting sculpture dance theater cinema music literature poetry photography crafts art",
          "hospital school bank post office pharmacy bakery market mall cinema theater museum gym",
          "banana apple orange grape pear mango pineapple strawberry watermelon kiwi papaya peach",
          "tomato lettuce carrot potato onion garlic cucumber broccoli cabbage spinach zucchini",
          "rice beans pasta meat chicken fish salad soup sauce seasoning olive oil vinegar herbs",
          "chocolate ice cream cake pudding candy pie cookie popcorn peanut cashew brownie sweet",
          "computer keyboard mouse monitor printer scanner laptop tablet phone charger headphones",
          "folder file document spreadsheet report contract proposal project agenda calendar notes",
          "television radio microwave fridge stove dishwasher vacuum fan heater air conditioner",
          "soccer volleyball basketball tennis swimming running cycling boxing surf chess yoga",
          "energy water light gas internet phone bill tax rent salary investment savings stock",
          "morning afternoon evening night dawn dusk sunrise sunset today tomorrow yesterday time",
          "spring summer autumn winter rain snow wind storm cloud rainbow thunder lightning weather"
        ],
        punctuation: [
          "chair, table, book, paper, pencil, phone, clock, door, window, bed, pillow, carpet, picture, frame.",
          "fork, plate, glass, water, juice, coffee, tea, milk, sugar, salt, pepper, bread, butter, cheese, ham.",
          "shoes, socks, pants, shirt, blouse, jacket, hat, glove, belt, bag, wallet, watch, glasses, clothes.",
          "doctor, lawyer, teacher, engineer, dentist, architect, salesman, accountant, chef, actor, writer.",
          "guitar, piano, drums, flute, saxophone, violin, harp, trumpet, keyboard, microphone, speaker, bass.",
          "mountain, beach, desert, forest, river, lake, ocean, island, cave, waterfall, volcano, glacier.",
          "plane, helicopter, train, bus, car, motorcycle, bicycle, boat, ship, rocket, submarine, scooter.",
          "painting, sculpture, dance, theater, cinema, music, literature, poetry, photography, crafts, art.",
          "hospital, school, bank, post office, pharmacy, bakery, market, mall, cinema, theater, museum, gym.",
          "banana, apple, orange, grape, pear, mango, pineapple, strawberry, watermelon, kiwi, papaya, peach.",
          "tomato, lettuce, carrot, potato, onion, garlic, cucumber, broccoli, cabbage, spinach, zucchini.",
          "rice, beans, pasta, meat, chicken, fish, salad, soup, sauce, seasoning, olive oil, vinegar, herbs.",
          "chocolate, ice cream, cake, pudding, candy, pie, cookie, popcorn, peanut, cashew, brownie, sweet.",
          "computer, keyboard, mouse, monitor, printer, scanner, laptop, tablet, phone, charger, headphones.",
          "folder, file, document, spreadsheet, report, contract, proposal, project, agenda, calendar, notes.",
          "television, radio, microwave, fridge, stove, dishwasher, vacuum, fan, heater, air conditioner.",
          "soccer, volleyball, basketball, tennis, swimming, running, cycling, boxing, surf, chess, yoga.",
          "energy, water, light, gas, internet, phone, bill, tax, rent, salary, investment, savings, stock.",
          "morning, afternoon, evening, night, dawn, dusk, sunrise, sunset, today, tomorrow, yesterday, time.",
          "spring, summer, autumn, winter, rain, snow, wind, storm, cloud, rainbow, thunder, lightning, weather."
        ]
      }
    }
  }
};

let currentText = '';
let currentMode = 'universal';
let currentSubMode = 'normal';
let currentLanguage = 'pt';
let currentIndex = 0;
let timer = null;
let timeLeft = 60;
let errors = 0;
let totalTyped = 0;
let isGameActive = false;

document.addEventListener('DOMContentLoaded', () => {
  document.addEventListener('selectstart', (e) => {
    e.preventDefault();
  });

  const modeButtons = document.querySelectorAll('.mode-btn');
  const subModeButtons = document.querySelectorAll('.sub-mode-btn');
  const languageSelector = document.querySelector('.language-selector');
  const restartButton = document.querySelector('.restart-btn');
  const textDisplay = document.querySelector('.text-display');

  // Initialize game
  initGame();

  // Mode selection
  modeButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      modeButtons.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      currentMode = this.textContent.toLowerCase();
      initGame();
    });
  });

  // Sub-mode selection
  subModeButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      subModeButtons.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      currentSubMode = this.dataset.mode;
      initGame();
    });
  });

  // Language selection
  languageSelector.addEventListener('change', function() {
    currentLanguage = this.value;
    initGame();
  });

  // Restart button
  restartButton.addEventListener('click', initGame);

  // Typing event
  document.addEventListener('keydown', handleTyping);
});

function initGame() {
  // Reset game state
  clearInterval(timer);
  currentIndex = 0;
  errors = 0;
  totalTyped = 0;
  timeLeft = 30;
  isGameActive = false;
  
  // Update timer display
  updateTimer();
  
  // Get new text
  currentText = getRandomText();
  
  // Display text
  displayText();
  
  // Update stats
  updateStats();
}

function getRandomText() {
  const difficultyTexts = texts[currentLanguage][currentMode]?.['easy']?.[currentSubMode];
  if (!difficultyTexts) return 'Text not available';
  
  // Combine all texts into one long string and split into words
  const allWords = difficultyTexts.join(' ').split(' ');
  
  // Shuffle the words
  const shuffledWords = allWords.sort(() => Math.random() - 0.5);
  
  // Take first 50 words and join them
  return shuffledWords.slice(0, 50).join(' ');
}

function displayText() {
  const textDisplay = document.querySelector('.text-display');
  textDisplay.innerHTML = '';
  
  const lineContainer = document.createElement('div');
  lineContainer.classList.add('line-container');
  
  const textLine = document.createElement('div');
  textLine.classList.add('text-line');
  
  // Create spans for each character
  currentText.split('').forEach((char, index) => {
    const span = document.createElement('span');
    span.classList.add('char');
    if (index === 0) span.classList.add('current');
    span.textContent = char;
    textLine.appendChild(span);
  });
  
  lineContainer.appendChild(textLine);
  textDisplay.appendChild(lineContainer);
}

function handleTyping(e) {
  if (e.key === ' ') {
    e.preventDefault();
  }

  if (!isGameActive && e.key.length === 1) {
    startGame();
  }

  if (!isGameActive) return;

  const currentChar = currentText[currentIndex];
  const typedChar = e.key;

  if (typedChar === currentChar) {
    // Correct character
    markCharacter(currentIndex, 'correct');
    currentIndex++;
    totalTyped++;
  } else if (e.key.length === 1) {
    // Incorrect character
    markCharacter(currentIndex, 'incorrect');
    errors++;
    totalTyped++;
  }

  // Move current marker
  if (currentIndex < currentText.length) {
    updateCurrentCharacter();
    
    // If we're 75% through the current text, generate and append more words
    if (currentIndex > (currentText.length * 0.75)) {
      appendMoreWords();
    }
  }

  updateStats();
}

function markCharacter(index, status) {
  const chars = document.querySelectorAll('.char');
  chars[index].classList.add(status);
}

function updateCurrentCharacter() {
  const chars = document.querySelectorAll('.char');
  chars.forEach(char => char.classList.remove('current'));
  
  if (currentIndex < chars.length) {
    chars[currentIndex].classList.add('current');
    
    // Scroll text to keep current character visible
    const currentChar = chars[currentIndex];
    const container = document.querySelector('.text-display');
    const lineContainer = document.querySelector('.line-container');
    
    const charOffset = currentChar.offsetLeft;
    const containerWidth = container.offsetWidth;
    const scrollAmount = charOffset - (containerWidth / 3);
    
    lineContainer.style.transform = `translateX(-${scrollAmount}px)`;
  }
}

function startGame() {
  isGameActive = true;
  timer = setInterval(() => {
    timeLeft--;
    updateTimer();
    if (timeLeft <= 0) {
      endGame();
    }
  }, 1000);
}

function endGame() {
  if (timeLeft <= 0) {
    clearInterval(timer);
    isGameActive = false;
    
    // Store current text for potential replay
    const lastText = currentText;
    
    // Create and show report modal
    showReport(lastText);
  }
}

function appendMoreWords() {
  const difficultyTexts = texts[currentLanguage][currentMode]?.['easy']?.[currentSubMode];
  if (!difficultyTexts) return;
  
  // Get all words and shuffle them
  const allWords = difficultyTexts.join(' ').split(' ');
  const shuffledWords = allWords.sort(() => Math.random() - 0.5);
  
  // Take 20 new words
  const newWords = shuffledWords.slice(0, 20).join(' ');
  
  // Append to current text
  currentText += ' ' + newWords;
  
  // Update display
  const textLine = document.querySelector('.text-line');
  newWords.split('').forEach(char => {
    const span = document.createElement('span');
    span.classList.add('char');
    span.textContent = char;
    textLine.appendChild(span);
  });
}

function showReport(lastText) {
  const modalHTML = `
    <div class="report-modal">
      <div class="report-content">
        <h2>Relatório de Desempenho</h2>
        <div class="report-stats">
          <div class="report-stat">
            <span class="stat-title">Velocidade</span>
            <span class="stat-value">${calculateWPM()} WPM</span>
          </div>
          <div class="report-stat">
            <span class="stat-title">Precisão</span>
            <span class="stat-value">${calculateAccuracy()}%</span>
          </div>
          <div class="report-stat">
            <span class="stat-title">Caracteres Corretos</span>
            <span class="stat-value">${totalTyped - errors}</span>
          </div>
          <div class="report-stat">
            <span class="stat-title">Erros</span>
            <span class="stat-value">${errors}</span>
          </div>
          <div class="report-graph">
            <div class="accuracy-bar" style="width: ${calculateAccuracy()}%"></div>
          </div>
        </div>
        <div class="report-actions">
          <button class="restart-same-btn">Repetir Mesmo Texto</button>
          <button class="restart-new-btn">Novo Texto</button>
        </div>
      </div>
    </div>
  `;

  // Add modal to body
  const modalElement = document.createElement('div');
  modalElement.innerHTML = modalHTML;
  document.body.appendChild(modalElement);

  // Add event listeners for buttons
  const sameTextBtn = modalElement.querySelector('.restart-same-btn');
  const newTextBtn = modalElement.querySelector('.restart-new-btn');

  sameTextBtn.addEventListener('click', () => {
    modalElement.remove();
    restartSameText(lastText);
  });

  newTextBtn.addEventListener('click', () => {
    modalElement.remove();
    initGame();
  });
}

function restartSameText(text) {
  // Reset game state but keep the same text
  clearInterval(timer);
  currentIndex = 0;
  errors = 0;
  totalTyped = 0;
  timeLeft = 30;
  isGameActive = false;
  
  // Set the same text
  currentText = text;
  
  // Update timer display
  updateTimer();
  
  // Display same text
  displayText();
  
  // Update stats
  updateStats();

  // Reset the scroll position
  const lineContainer = document.querySelector('.line-container');
  if (lineContainer) {
    lineContainer.style.transform = 'translateX(0)';
  }
}

function calculateWPM() {
  const minutes = (30 - timeLeft) / 60;
  if (minutes === 0) return 0;
  return Math.round((totalTyped / 5) / minutes);
}

function calculateAccuracy() {
  if (totalTyped === 0) return 100;
  return Math.round(((totalTyped - errors) / totalTyped) * 100);
}

function updateTimer() {
  const timerElement = document.querySelector('.timer');
  timerElement.textContent = timeLeft;
  document.getElementById('time').textContent = timeLeft + 's';
}

function updateStats() {
  const wpm = Math.round((totalTyped / 5) * (60 / (30 - timeLeft)));
  const accuracy = Math.round(((totalTyped - errors) / totalTyped) * 100) || 100;

  document.getElementById('wpm').textContent = isFinite(wpm) ? wpm : 0;
  document.getElementById('accuracy').textContent = accuracy + '%';
}
