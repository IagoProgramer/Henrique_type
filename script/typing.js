const texts = {
  pt: {
    universal: {
      easy: {
        normal: [
          "cadeira mesa livro papel caneta telefone relogio porta janela cama almofada tapete quadro",
          "garfo prato copo agua suco cafe cha leite acucar sal pimenta pao manteiga queijo presunto",
          "sapato meia calca camisa blusa casaco chapeu luva cinto bolsa carteira relogio oculos",
          "cachorro gato peixe passaro coelho hamster papagaio tartaruga porquinho rato girafa leao",
          "cozinha sala quarto banheiro garagem jardim quintal varanda sacada escritorio lavanderia",
          "medico advogado professor engenheiro dentista arquiteto vendedor contador cozinheiro ator",
          "violao guitarra piano bateria flauta saxofone violino harpa tambor teclado microfone",
          "montanha praia deserto floresta rio lago oceano ilha caverna cachoeira vulcao geleira",
          "aviao helicoptero trem onibus carro moto bicicleta barco navio foguete submarino",
          "pintura escultura danca teatro cinema musica literatura poesia fotografia artesanato",
          "hospital escola banco correio farmacia padaria mercado shopping cinema teatro museu",
          "banana maca laranja uva pera manga abacaxi morango melancia kiwi mamao pessego ameixa",
          "tomate alface cenoura batata cebola alho pepino brocolis couve espinafre abobrinha",
          "arroz feijao macarrao carne frango peixe salada sopa molho tempero azeite vinagre",
          "chocolate sorvete bolo pudim doce torta biscoito pipoca amendoim castanha brigadeiro",
          "computador teclado mouse monitor impressora scanner notebook tablet celular carregador",
          "pasta arquivo documento planilha relatorio contrato proposta projeto agenda calendario",
          "televisao radio microondas geladeira fogao maquina lavlouca aspirador ventilador",
          "futebol volei basquete tenis natacao corrida ciclismo boxe surf xadrez yoga pilates",
          "energia agua luz gas internet telefone conta imposto aluguel salario investimento"
        ],
        accents: [
          "cadeira mesa livro papel caneta telefone relógio porta janela cama almofada tapete quadro",
          "garfo prato copo água suco café chá leite açúcar sal pimenta pão manteiga queijo presunto",
          "sapato meia calça camisa blusa casaco chapéu luva cinto bolsa carteira relógio óculos",
          "cachorro gato peixe pássaro coelho hamster papagaio tartaruga porquinho rato girafa leão",
          "cozinha sala quarto banheiro garagem jardim quintal varanda sacada escritório lavanderia",
          "médico advogado professor engenheiro dentista arquiteto vendedor contador cozinheiro ator",
          "violão guitarra piano bateria flauta saxofone violino harpa tambor teclado microfone",
          "montanha praia deserto floresta rio lago oceano ilha caverna cachoeira vulcão geleira",
          "avião helicóptero trem ônibus carro moto bicicleta barco navio foguete submarino",
          "pintura escultura dança teatro cinema música literatura poesia fotografia artesanato",
          "hospital escola banco correio farmácia padaria mercado shopping cinema teatro museu",
          "banana maçã laranja uva pera manga abacaxi morango melancia kiwi mamão pêssego ameixa",
          "tomate alface cenoura batata cebola alho pepino brócolis couve espinafre abobrinha",
          "arroz feijão macarrão carne frango peixe salada sopa molho tempero azeite vinagre",
          "chocolate sorvete bolo pudim doce torta biscoito pipoca amendoim castanha brigadeiro",
          "computador teclado mouse monitor impressora scanner notebook tablet celular carregador",
          "pasta arquivo documento planilha relatório contrato proposta projeto agenda calendário",
          "televisão rádio micro-ondas geladeira fogão máquina lava-louça aspirador ventilador",
          "futebol vôlei basquete tênis natação corrida ciclismo boxe surf xadrez yoga pilates",
          "energia água luz gás internet telefone conta imposto aluguel salário investimento"
        ],
        punctuation: [
          "cadeira, mesa, livro, papel, caneta, telefone, relógio, porta, janela, cama, almofada, tapete, quadro.",
          "garfo, prato, copo, água, suco, café, chá, leite, açúcar, sal, pimenta, pão, manteiga, queijo, presunto.",
          "sapato, meia, calça, camisa, blusa, casaco, chapéu, luva, cinto, bolsa, carteira, relógio, óculos.",
          "cachorro, gato, peixe, pássaro, coelho, hamster, papagaio, tartaruga, porquinho, rato, girafa, leão.",
          "cozinha, sala, quarto, banheiro, garagem, jardim, quintal, varanda, sacada, escritório, lavanderia.",
          "médico, advogado, professor, engenheiro, dentista, arquiteto, vendedor, contador, cozinheiro, ator.",
          "violão, guitarra, piano, bateria, flauta, saxofone, violino, harpa, tambor, teclado, microfone.",
          "montanha, praia, deserto, floresta, rio, lago, oceano, ilha, caverna, cachoeira, vulcão, geleira.",
          "avião, helicóptero, trem, ônibus, carro, moto, bicicleta, barco, navio, foguete, submarino.",
          "pintura, escultura, dança, teatro, cinema, música, literatura, poesia, fotografia, artesanato.",
          "hospital, escola, banco, correio, farmácia, padaria, mercado, shopping, cinema, teatro, museu.",
          "banana, maçã, laranja, uva, pera, manga, abacaxi, morango, melancia, kiwi, mamão, pêssego, ameixa.",
          "tomate, alface, cenoura, batata, cebola, alho, pepino, brócolis, couve, espinafre, abobrinha.",
          "arroz, feijão, macarrão, carne, frango, peixe, salada, sopa, molho, tempero, azeite, vinagre.",
          "chocolate, sorvete, bolo, pudim, doce, torta, biscoito, pipoca, amendoim, castanha, brigadeiro.",
          "computador, teclado, mouse, monitor, impressora, scanner, notebook, tablet, celular, carregador.",
          "pasta, arquivo, documento, planilha, relatório, contrato, proposta, projeto, agenda, calendário.",
          "televisão, rádio, micro-ondas, geladeira, fogão, máquina lava-louça, aspirador, ventilador.",
          "futebol, vôlei, basquete, tênis, natação, corrida, ciclismo, boxe, surf, xadrez, yoga, pilates.",
          "energia, água, luz, gás, internet, telefone, conta, imposto, aluguel, salário, investimento"
        ]
      }
    },
    javascript: {
      easy: {
        normal: [
          "const let var function return if else for while do break continue switch case default class",
          "async await Promise fetch then catch finally try throw new this super extends implements",
          "import export default from as module require package node npm install dependencies devDependencies",
          "array object string number boolean null undefined symbol map set weakmap weakset date math",
          "console log error info warn debug trace assert clear count time timeEnd group groupEnd",
          "dom document window element node text fragment event listener mutation observer selector",
          "react component props state hooks effect context redux saga thunk middleware store reducer",
          "angular component service pipe directive module decorator injection template routing guard",
          "vue component template script style props emit watch computed methods lifecycle directives",
          "typescript interface type enum namespace declare extends implements public private protected"
        ],
        accents: [
          "função retorno variável método classe construtor herança polimorfismo encapsulamento",
          "programação orientada objetos módulo pacote biblioteca dependência desenvolvimento produção",
          "aplicação cliente servidor banco dados conexão requisição resposta autenticação autorização",
          "código fonte debug erro exceção log teste unitário integração cobertura qualidade padrão",
          "interface usuário componente template estilo diretiva serviço injeção dependência roteamento"
        ],
        punctuation: [
          "function multiply(x, y) { return x * y; }",
          "const array = [1, 2, 3, 4, 5];",
          "let obj = { name: 'John', age: 30 };",
          "if (condition) { doSomething(); }",
          "for (let i = 0; i < array.length; i++) { }"
        ]
      }
    
  },
  en: {
    universal: {
      easy: {
        normal: [
          "chair table book paper pencil phone clock door window bed pillow carpet picture frame",
          "fork plate glass water juice coffee tea milk sugar salt pepper bread butter cheese ham",
          "shoes socks pants shirt blouse jacket hat glove belt bag wallet watch glasses clothes",
          "doctor lawyer teacher engineer dentist architect salesman accountant chef actor writer",
          "guitar piano drums flute saxophone violin harp trumpet keyboard microphone speaker bass",
          "mountain beach desert forest river lake ocean island cave waterfall volcano glacier",
          "plane helicopter train bus car motorcycle bicycle boat ship rocket submarine scooter",
          "painting sculpture dance theater cinema music literature poetry photography crafts art",
          "hospital school bank post office pharmacy bakery market mall cinema theater museum gym",
          "banana apple orange grape pear mango pineapple strawberry watermelon kiwi papaya peach",
          "tomato lettuce carrot potato onion garlic cucumber broccoli cabbage spinach zucchini",
          "rice beans pasta meat chicken fish salad soup sauce seasoning olive oil vinegar herbs",
          "chocolate ice cream cake pudding candy pie cookie popcorn peanut cashew brownie sweet",
          "computer keyboard mouse monitor printer scanner laptop tablet phone charger headphones",
          "folder file document spreadsheet report contract proposal project agenda calendar notes",
          "television radio microwave fridge stove dishwasher vacuum fan heater air conditioner",
          "soccer volleyball basketball tennis swimming running cycling boxing surf chess yoga",
          "energy water light gas internet phone bill tax rent salary investment savings stock",
          "morning afternoon evening night dawn dusk sunrise sunset today tomorrow yesterday time",
          "spring summer autumn winter rain snow wind storm cloud rainbow thunder lightning weather"
        ],
        accents: [
          "chair table book paper pencil phone clock door window bed pillow carpet picture frame",
          "fork plate glass water juice coffee tea milk sugar salt pepper bread butter cheese ham",
          "shoes socks pants shirt blouse jacket hat glove belt bag wallet watch glasses clothes",
          "doctor lawyer teacher engineer dentist architect salesman accountant chef actor writer",
          "guitar piano drums flute saxophone violin harp trumpet keyboard microphone speaker bass",
          "mountain beach desert forest river lake ocean island cave waterfall volcano glacier",
          "plane helicopter train bus car motorcycle bicycle boat ship rocket submarine scooter",
          "painting sculpture dance theater cinema music literature poetry photography crafts art",
          "hospital school bank post office pharmacy bakery market mall cinema theater museum gym",
          "banana apple orange grape pear mango pineapple strawberry watermelon kiwi papaya peach",
          "tomato lettuce carrot potato onion garlic cucumber broccoli cabbage spinach zucchini",
          "rice beans pasta meat chicken fish salad soup sauce seasoning olive oil vinegar herbs",
          "chocolate ice cream cake pudding candy pie cookie popcorn peanut cashew brownie sweet",
          "computer keyboard mouse monitor printer scanner laptop tablet phone charger headphones",
          "folder file document spreadsheet report contract proposal project agenda calendar notes",
          "television radio microwave fridge stove dishwasher vacuum fan heater air conditioner",
          "soccer volleyball basketball tennis swimming running cycling boxing surf chess yoga",
          "energy water light gas internet phone bill tax rent salary investment savings stock",
          "morning afternoon evening night dawn dusk sunrise sunset today tomorrow yesterday time",
          "spring summer autumn winter rain snow wind storm cloud rainbow thunder lightning weather"
        ],
        punctuation: [
          "chair, table, book, paper, pencil, phone, clock, door, window, bed, pillow, carpet, picture, frame.",
          "fork, plate, glass, water, juice, coffee, tea, milk, sugar, salt, pepper, bread, butter, cheese, ham.",
          "shoes, socks, pants, shirt, blouse, jacket, hat, glove, belt, bag, wallet, watch, glasses, clothes.",
          "doctor, lawyer, teacher, engineer, dentist, architect, salesman, accountant, chef, actor, writer.",
          "guitar, piano, drums, flute, saxophone, violin, harp, trumpet, keyboard, microphone, speaker, bass.",
          "mountain, beach, desert, forest, river, lake, ocean, island, cave, waterfall, volcano, glacier.",
          "plane, helicopter, train, bus, car, motorcycle, bicycle, boat, ship, rocket, submarine, scooter.",
          "painting, sculpture, dance, theater, cinema, music, literature, poetry, photography, crafts, art.",
          "hospital, school, bank, post office, pharmacy, bakery, market, mall, cinema, theater, museum, gym.",
          "banana, apple, orange, grape, pear, mango, pineapple, strawberry, watermelon, kiwi, papaya, peach.",
          "tomato, lettuce, carrot, potato, onion, garlic, cucumber, broccoli, cabbage, spinach, zucchini.",
          "rice, beans, pasta, meat, chicken, fish, salad, soup, sauce, seasoning, olive oil, vinegar, herbs.",
          "chocolate, ice cream, cake, pudding, candy, pie, cookie, popcorn, peanut, cashew, brownie, sweet.",
          "computer, keyboard, mouse, monitor, printer, scanner, laptop, tablet, phone, charger, headphones.",
          "folder, file, document, spreadsheet, report, contract, proposal, project, agenda, calendar, notes.",
          "television, radio, microwave, fridge, stove, dishwasher, vacuum, fan, heater, air conditioner.",
          "soccer, volleyball, basketball, tennis, swimming, running, cycling, boxing, surf, chess, yoga.",
          "energy, water, light, gas, internet, phone, bill, tax, rent, salary, investment, savings, stock.",
          "morning, afternoon, evening, night, dawn, dusk, sunrise, sunset, today, tomorrow, yesterday, time.",
          "spring, summer, autumn, winter, rain, snow, wind, storm, cloud, rainbow, thunder, lightning, weather."
        ]
      }
    }
  },
  python: {
    easy: {
      normal: [
        "def class return yield lambda if elif else for while do break continue pass raise try except",
        "import from as with open print input range len str int float list tuple dict set bool",
        "self super none true false and or not in is global nonlocal del assert match case",
        "list comprehension generator decorator iterator iterable sequence mapping callable hashable",
        "pandas numpy matplotlib scikit learn tensorflow keras pytorch seaborn requests beautiful soup",
        "django flask fastapi pyramid web framework template view model controller router middleware",
        "object oriented programming inheritance polymorphism encapsulation abstraction interface class",
        "virtual environment package manager pip conda requirements dependencies development production",
        "database sql nosql mongodb postgresql mysql sqlite oracle connection query schema migration",
        "unit test pytest unittest mock fixture coverage quality assurance continuous integration"
      ],
      accents: [
        "função retorno variável método classe construtor herança polimorfismo encapsulamento",
        "programação orientada objetos módulo pacote biblioteca dependência desenvolvimento produção",
        "aplicação cliente servidor banco dados conexão requisição resposta autenticação autorização",
        "código fonte depuração erro exceção registro teste unitário integração cobertura qualidade"
      ],
      punctuation: [
        "def calculate_sum(a, b):",
        "class Person(object):",
        "if condition == True:",
        "for item in items:",
        "try: except Exception as e:"
      ]
    }
  },
  java: {
    easy: {
      normal: [
        "public private protected class interface extends implements abstract static final void return",
        "int long double float boolean char string byte short array list map set queue stack vector",
        "if else for while do break continue switch case default try catch finally throw throws new",
        "package import class method constructor inheritance polymorphism encapsulation abstraction",
        "spring boot hibernate jpa rest api mvc repository service controller entity component bean",
        "maven gradle dependency management build tool test junit mockito selenium jenkins docker",
        "collection framework list set queue map iterator comparator comparable serializable cloneable",
        "exception handling runtime error checked unchecked custom throw throws try catch finally",
        "thread runnable callable future executor service parallel stream synchronize volatile atomic",
        "object oriented programming inheritance polymorphism encapsulation abstraction interface enum"
      ],
      accents: [
        "função retorno variável método classe construtor herança polimorfismo encapsulamento",
        "programação orientada objetos módulo pacote biblioteca dependência desenvolvimento produção",
        "aplicação cliente servidor banco dados conexão requisição resposta autenticação autorização",
        "código fonte depuração erro exceção registro teste unitário integração cobertura qualidade"
      ],
      punctuation: [
        "public class Main { }",
        "if (condition) { }",
        "for (int i = 0; i < n; i++) { }",
        "try { } catch (Exception e) { }",
        "public void method() { }"
      ]
    }
  },
  csharp: {
    easy: {
      normal: [
        "public private protected internal class interface struct enum delegate event using namespace",
        "int long double decimal float bool char string object dynamic var list dictionary hashset",
        "if else for foreach while do break continue switch case default try catch finally throw new",
        "async await task parallel linq lambda expression extension method attribute reflection generic",
        "asp net core mvc api controller action filter middleware service dependency injection entity",
        "nuget package manager visual studio resharper rider debug test mstest nunit xunit moq",
        "collection list dictionary hashset queue stack linked list sorted list concurrent collection",
        "exception handling try catch finally throw custom exception debug trace console log assertion",
        "thread task parallel programming async await synchronization lock monitor semaphore mutex",
        "wpf xaml windows forms blazor razor pages signal entity framework core dapper identity"
      ],
      accents: [
        "função retorno variável método classe construtor herança polimorfismo encapsulamento",
        "programação orientada objetos módulo pacote biblioteca dependência desenvolvimento produção",
        "aplicação cliente servidor banco dados conexão requisição resposta autenticação autorização",
        "código fonte depuração erro exceção registro teste unitário integração cobertura qualidade"
      ],
      punctuation: [
        "public class Program { }",
        "if (condition) { }",
        "foreach (var item in items) { }",
        "try { } catch (Exception ex) { }",
        "public void Method() { }"
      ]
    }
  },
  htmlcss: {
    easy: {
      normal: [
        "html head body div span p a img ul ol li table tr td th form input button select option",
        "header nav main section article aside footer figure figcaption picture source time details",
        "display flex grid block inline none position relative absolute fixed sticky float clear",
        "margin padding border width height background color font text align transform transition",
        "media query breakpoint responsive mobile desktop tablet container wrapper layout framework",
        "sass scss variable mixin extend import function directive operator nesting parent selector",
        "bootstrap tailwind foundation bulma material design semantic ui element component utility",
        "animation keyframes transform transition filter blur opacity gradient shadow outline border",
        "flexbox grid container item justify content align items self wrap direction basis grow",
        "selector class id attribute pseudo element combinators specificity inheritance cascading"
      ],
      accents: [
        "seletor classe identificador atributo elemento pseudo combinação especificidade herança",
        "animação transformação transição filtro gradiente sombra contorno borda espaçamento",
        "posição relativa absoluta fixa aderente flutuante limpar margem preenchimento altura",
        "mídia consulta ponto quebra responsivo móvel área trabalho tablet recipiente estrutura"
      ],
      punctuation: [
        "<div class=\"container\"> </div>",
        "<p id=\"paragraph\">Text</p>",
        "@media screen and (max-width: 768px) { }",
        ".class { property: value; }",
        "#id { margin: 0; padding: 0; }"
      ]
    }
  }
};

let currentText = '';
let currentMode = 'universal';
let currentSubMode = 'normal';
let currentLanguage = 'pt';
let currentIndex = 0;
let timer = null;
let timeLeft = 30;
let errors = 0;
let totalTyped = 0;
let isGameActive = false;

document.addEventListener('DOMContentLoaded', () => {
  const textDisplay = document.querySelector('.text-display');
  const timerElement = document.querySelector('.timer');
  const wpmElement = document.getElementById('wpm');
  const accuracyElement = document.getElementById('accuracy');
  const timeElement = document.getElementById('time');
  const mobileInput = document.getElementById('mobile-input');
  
  if (!textDisplay || !timerElement || !wpmElement || !accuracyElement || !timeElement) {
    console.error('Required elements not found');
    return;
  }

  document.addEventListener('selectstart', (e) => {
    e.preventDefault();
  });

  const modeButtons = document.querySelectorAll('.mode-btn');
  const subModeButtons = document.querySelectorAll('.sub-mode-btn');
  const languageSelector = document.querySelector('.language-selector');
  const restartButton = document.querySelector('.restart-btn');

  if (modeButtons.length && subModeButtons.length && languageSelector && restartButton) {
    initGame();

    modeButtons.forEach(btn => {
      btn.addEventListener('click', function() {
        modeButtons.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentMode = this.textContent.toLowerCase();
        initGame();
      });
    });

    subModeButtons.forEach(btn => {
      btn.addEventListener('click', function() {
        subModeButtons.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentSubMode = this.dataset.mode;
        initGame();
      });
    });

    languageSelector.addEventListener('change', function() {
      currentLanguage = this.value;
      initGame();
    });

    restartButton.addEventListener('click', initGame);
  }

  document.addEventListener('keydown', handleTyping);

  if (mobileInput) {
    mobileInput.addEventListener('input', (e) => {
      const char = e.target.value;
      if (char) {
        processTypedCharacter(char);
      }
      mobileInput.value = '';
    });
  }
});

function initGame() {
  const languageSelector = document.querySelector('.language-selector');
  
  if (languageSelector) {
    if (currentMode === 'universal') {
      languageSelector.style.display = 'block';
    } else {
      languageSelector.style.display = 'none';
      currentLanguage = 'pt';
    }
  }

  clearInterval(timer);
  currentIndex = 0;
  errors = 0;
  totalTyped = 0;
  timeLeft = 30;
  isGameActive = false;
  
  updateTimer();
  currentText = getRandomText();
  displayText();
  updateStats();
}

function getRandomText() {
  let textSource;
  
  if (currentMode === 'universal') {
    textSource = texts[currentLanguage][currentMode]?.['easy']?.[currentSubMode];
  } else {
    const modeKey = currentMode.toLowerCase().replace('/', '').replace('#', 'sharp');
    textSource = texts[modeKey]?.['easy']?.[currentSubMode];
  }
  
  if (!textSource) return 'Text not available';
  
  const allWords = textSource.join(' ').split(' ');
  
  const shuffledWords = allWords.sort(() => Math.random() - 0.5);
  
  return shuffledWords.slice(0, 50).join(' ');
}

function displayText() {
  const textDisplay = document.querySelector('.text-display');
  textDisplay.innerHTML = '';
  
  const lineContainer = document.createElement('div');
  lineContainer.classList.add('line-container');
  
  const textLine = document.createElement('div');
  textLine.classList.add('text-line');
  
  currentText.split('').forEach((char, index) => {
    const span = document.createElement('span');
    span.classList.add('char');
    if (index === 0) span.classList.add('current');
    span.textContent = char;
    textLine.appendChild(span);
  });
  
  lineContainer.appendChild(textLine);
  textDisplay.appendChild(lineContainer);
}

function handleTyping(e) {
  if (e.key === ' ') {
    e.preventDefault();
  }

  if (!isGameActive && e.key.length === 1) {
    startGame();
  }

  if (!isGameActive) return;

  const currentChar = currentText[currentIndex];

  if (e.key === currentChar) {
    markCharacter(currentIndex, 'correct');
    currentIndex++;
    totalTyped++;
  } else if (e.key.length === 1) {
    markCharacter(currentIndex, 'incorrect');
    errors++;
    totalTyped++;
  }

  if (currentIndex < currentText.length) {
    updateCurrentCharacter();
    
    if (currentIndex > (currentText.length * 0.75)) {
      appendMoreWords();
    }
  }

  updateStats();
}

function markCharacter(index, status) {
  const chars = document.querySelectorAll('.char');
  chars[index].classList.add(status);
}

function updateCurrentCharacter() {
  const chars = document.querySelectorAll('.char');
  chars.forEach(char => char.classList.remove('current'));
  
  if (currentIndex < chars.length) {
    chars[currentIndex].classList.add('current');
    
    const currentChar = chars[currentIndex];
    const container = document.querySelector('.text-display');
    const lineContainer = document.querySelector('.line-container');
    
    const charOffset = currentChar.offsetLeft;
    const containerWidth = container.offsetWidth;
    const scrollAmount = charOffset - (containerWidth / 3);
    
    lineContainer.style.transform = `translateX(-${scrollAmount}px)`;
  }
}

function startGame() {
  isGameActive = true;
  timer = setInterval(() => {
    timeLeft--;
    updateTimer();
    if (timeLeft <= 0) {
      endGame();
    }
  }, 1000);
}

function endGame() {
  if (timeLeft <= 0) {
    clearInterval(timer);
    isGameActive = false;
    
    const lastText = currentText;
    
    showReport(lastText);
  }
}

function appendMoreWords() {
  const difficultyTexts = texts[currentLanguage][currentMode]?.['easy']?.[currentSubMode];
  if (!difficultyTexts) return;
  
  const allWords = difficultyTexts.join(' ').split(' ');
  
  const shuffledWords = allWords.sort(() => Math.random() - 0.5);
  
  const newWords = shuffledWords.slice(0, 20).join(' ');
  
  currentText += ' ' + newWords;
  
  const textLine = document.querySelector('.text-line');
  newWords.split('').forEach(char => {
    const span = document.createElement('span');
    span.classList.add('char');
    span.textContent = char;
    textLine.appendChild(span);
  });
}

function showReport(lastText) {
  const existingModal = document.querySelector('.report-modal');
  if (existingModal) {
    existingModal.remove();
  }

  const modalHTML = `
    <div class="report-modal">
      <div class="report-content">
        <h2>Relatório de Desempenho</h2>
        <div class="report-stats">
          <div class="report-stat">
            <span class="stat-title">Velocidade</span>
            <span class="stat-value">${calculateWPM()} WPM</span>
          </div>
          <div class="report-stat">
            <span class="stat-title">Precisão</span>
            <span class="stat-value">${calculateAccuracy()}%</span>
          </div>
          <div class="report-stat">
            <span class="stat-title">Caracteres Corretos</span>
            <span class="stat-value">${totalTyped - errors}</span>
          </div>
          <div class="report-stat">
            <span class="stat-title">Erros</span>
            <span class="stat-value">${errors}</span>
          </div>
          <div class="report-graph">
            <div class="accuracy-bar" style="width: ${calculateAccuracy()}%"></div>
          </div>
        </div>
        <div class="report-actions">
          <button class="restart-same-btn">Repetir Mesmo Texto</button>
          <button class="restart-new-btn">Novo Texto</button>
        </div>
      </div>
    </div>
  `;

  const modalElement = document.createElement('div');
  modalElement.innerHTML = modalHTML;
  document.body.appendChild(modalElement);

  const sameTextBtn = modalElement.querySelector('.restart-same-btn');
  const newTextBtn = modalElement.querySelector('.restart-new-btn');

  if (sameTextBtn && newTextBtn) {
    sameTextBtn.addEventListener('click', () => {
      modalElement.remove();
      restartSameText(lastText);
    });

    newTextBtn.addEventListener('click', () => {
      modalElement.remove();
      initGame();
    });
  }
}

function restartSameText(text) {
  clearInterval(timer);
  currentIndex = 0;
  errors = 0;
  totalTyped = 0;
  timeLeft = 30;
  isGameActive = false;
  
  currentText = text;
  
  updateTimer();
  
  displayText();
  
  updateStats();

  const lineContainer = document.querySelector('.line-container');
  if (lineContainer) {
    lineContainer.style.transform = 'translateX(0)';
  }
}

function calculateWPM() {
  const minutes = (30 - timeLeft) / 60;
  if (minutes === 0) return 0;
  return Math.round((totalTyped / 5) / minutes);
}

function calculateAccuracy() {
  if (totalTyped === 0) return 100;
  return Math.round(((totalTyped - errors) / totalTyped) * 100);
}

function updateTimer() {
  const timerElement = document.querySelector('.timer');
  timerElement.textContent = timeLeft;
  document.getElementById('time').textContent = timeLeft + 's';
}

function updateStats() {
  const wpm = Math.round((totalTyped / 5) * (60 / (30 - timeLeft)));
  const accuracy = Math.round(((totalTyped - errors) / totalTyped) * 100) || 100;

  document.getElementById('wpm').textContent = isFinite(wpm) ? wpm : 0;
  document.getElementById('accuracy').textContent = accuracy + '%';
}

function processTypedCharacter(char) {
  if (!isGameActive) {
    startGame();
  }

  if (!isGameActive) return;

  const currentChar = currentText[currentIndex];

  if (char === currentChar) {
    markCharacter(currentIndex, 'correct');
    currentIndex++;
    totalTyped++;
  } else {
    markCharacter(currentIndex, 'incorrect');
    errors++;
    totalTyped++;
  }

  if (currentIndex < currentText.length) {
    updateCurrentCharacter();
    
    if (currentIndex > (currentText.length * 0.75)) {
      appendMoreWords();
    }
  }

  updateStats();
}
